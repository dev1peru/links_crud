<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>My Links</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background:#f7f7f7; }
  .topbar { display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; }
  .topbar h2 { margin:0; }
  .right { display:flex; gap:8px; align-items:center; }
  .hint { font-size:12px; opacity:.7; }

  /* VIEW MODE: 3 columns max */
  .grid.view-layout{
    display:grid;
    grid-template-columns:repeat(3, 1fr);
    gap:12px;
  }
  @media (max-width: 1100px){ .grid.view-layout{ grid-template-columns:repeat(2, 1fr); } }
  @media (max-width: 700px){ .grid.view-layout{ grid-template-columns:repeat(1, 1fr); } }

  /* EDIT MODE: vertical list */
  .grid.edit-layout{
    display:flex;
    flex-direction:column;
    gap:12px;
    align-items:center;
  }

  .card {
    border:1px solid #ddd;
    border-radius:12px;
    padding:12px;
    background:white;
  }
  .grid.edit-layout .section-card{ width:100%; max-width:1100px; }
  .section-card.dragging { opacity:.45; }

  .section-header { display:flex; justify-content:space-between; align-items:center; gap:10px; }
  .section-left { display:flex; align-items:center; gap:10px; flex:1; min-width:0; }

  .section-handle, .drag-handle {
    cursor:grab; user-select:none; opacity:.75; font-size:14px;
    padding:4px 6px; border-radius:8px; border:1px solid #eee; background:#fafafa;
  }
  .section-handle:active, .drag-handle:active { cursor:grabbing; }

  .row { display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
  input, select {
    flex:1; min-width:220px; padding:8px;
    border-radius:8px; border:1px solid #ddd;
  }

  button { cursor:pointer; padding:8px 10px; border-radius:8px; border:1px solid #ddd; background:#fafafa; }
  button:disabled { opacity:.5; cursor:not-allowed; }
  .btn-primary { background:#111; color:white; border-color:#111; }
  .btn-danger { background:#ff4d4d; color:white; font-size:12px; padding:4px 8px; border-radius:8px; border-color:#ff4d4d; }
  .btn-small { padding:6px 10px; font-size:12px; }

  .link-row {
    display:flex; align-items:center; gap:10px;
    padding:6px 8px;
    border:1px solid #eee;
    border-radius:10px;
    margin:6px 0;
    background:white;
  }
  .link-row.dragging { opacity:.5; }
  .link-title { flex:1; text-decoration:none; color:#111; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .link-title:hover { text-decoration:underline; }

  .hidden { display:none !important; }

  /* Section color styling */
  .section-color-bar { height:6px; border-radius:10px; margin:-12px -12px 10px -12px; }
  .c-slate { background:#64748b; }
  .c-blue { background:#3b82f6; }
  .c-green { background:#22c55e; }
  .c-amber { background:#f59e0b; }
  .c-red { background:#ef4444; }
  .c-purple { background:#a855f7; }
  .c-pink { background:#ec4899; }
  .c-teal { background:#14b8a6; }

  .edit-inline { display:flex; gap:8px; align-items:center; flex-wrap:wrap; width:100%; }
  .edit-inline input { min-width:200px; }
</style>
</head>
<body>

<div class="topbar">
  <h2>My Links</h2>
  <div class="right">
    <span id="modeHint" class="hint">View mode</span>
    <button id="editBtn" class="btn-primary" onclick="toggleEdit()">Edit</button>
  </div>
</div>

<div class="row">
  <input id="sectionName" placeholder="New section name (e.g., Tools)">
  <button id="addSectionBtn" onclick="createSection()" disabled>Add Section</button>
</div>

<hr>
<div id="grid" class="grid view-layout"></div>

<script>
let editMode = false;
let dirtySectionsOrder = false;
const dirtyLinksOrderBySection = new Set();

let draggedSectionCard = null;
let draggedLinkEl = null;

const COLORS = [
  { value:"slate", label:"Slate" },
  { value:"blue", label:"Blue" },
  { value:"green", label:"Green" },
  { value:"amber", label:"Amber" },
  { value:"red", label:"Red" },
  { value:"purple", label:"Purple" },
  { value:"pink", label:"Pink" },
  { value:"teal", label:"Teal" },
];

function toggleEdit(){
  editMode = !editMode;
  if (!editMode) {
    saveAllOrders().then(load);
  } else {
    load();
  }
}

async function saveAllOrders(){
  if (dirtySectionsOrder) {
    await persistSectionOrder();
    dirtySectionsOrder = false;
  }

  // Copy set -> array to avoid mutation issues
  const sids = Array.from(dirtyLinksOrderBySection);
  for (const sid of sids) {
    await persistLinkOrder(sid);
  }
  dirtyLinksOrderBySection.clear();
}

function setTopbar(){
  const hint = document.getElementById("modeHint");
  const btn = document.getElementById("editBtn");
  const addBtn = document.getElementById("addSectionBtn");
  const grid = document.getElementById("grid");

  if (editMode){
    hint.textContent = "Edit mode";
    btn.textContent = "Save";
    addBtn.disabled = false;
    grid.className = "grid edit-layout";
  } else {
    hint.textContent = "View mode";
    btn.textContent = "Edit";
    addBtn.disabled = true;
    grid.className = "grid view-layout";
  }
}

function colorOptionsHtml(selected){
  return COLORS.map(c => `<option value="${c.value}" ${c.value===selected?"selected":""}>${c.label}</option>`).join("");
}

async function load(){
  setTopbar();

  const res = await fetch("/sections");
  const sections = await res.json();

  const grid = document.getElementById("grid");
  grid.innerHTML = "";

  sections.forEach(s => {
    const card = document.createElement("div");
    card.className = "card section-card";
    card.dataset.sectionId = String(s.id);

    // IMPORTANT: we don't drag the whole card; only the handle is draggable.
    card.draggable = false;

    const color = (s.color || "slate").toLowerCase();

    const titleBlock = editMode
      ? `
        <div class="edit-inline">
          <input id="rename-${s.id}" value="${escapeAttr(s.name)}">
          <button class="btn-small" onclick="updateSectionName(${s.id})">Rename</button>

          <select id="color-${s.id}">
            ${colorOptionsHtml(color)}
          </select>
          <button class="btn-small" onclick="updateSectionColor(${s.id})">Set Color</button>
        </div>
      `
      : `<h3 style="margin:0">${escapeHtml(s.name)}</h3>`;

    card.innerHTML = `
      <div class="section-color-bar c-${color}"></div>

      <div class="section-header">
        <div class="section-left">
          <span class="section-handle ${editMode ? "" : "hidden"}" title="Drag section">‚ò∞</span>
          ${titleBlock}
        </div>
        <button class="btn-danger ${editMode ? "" : "hidden"}" onclick="deleteSection(${s.id})">üóëÔ∏è</button>
      </div>

      <div class="row ${editMode ? "" : "hidden"}">
        <input id="title-${s.id}" placeholder="Title">
        <input id="url-${s.id}" placeholder="https://...">
        <button onclick="addLink(${s.id})">Add</button>
      </div>

      <div id="links-${s.id}"></div>
    `;

    if (editMode) addSectionDnDHandlers(card);
    grid.appendChild(card);

    const linksDiv = card.querySelector(`#links-${s.id}`);

    s.links.forEach(l => {
      const row = document.createElement("div");
      row.className = "link-row";
      row.dataset.linkId = String(l.id);
      row.draggable = false; // drag only from handle

      const linkView = `<a href="${l.url}" target="_blank" class="link-title">${escapeHtml(l.title)}</a>`;

      const linkEdit = `
        <input id="lt-${l.id}" value="${escapeAttr(l.title)}">
        <input id="lu-${l.id}" value="${escapeAttr(l.url)}">
        <button class="btn-small" onclick="updateLink(${l.id})">Update</button>
      `;

      row.innerHTML = `
        <span class="drag-handle ${editMode ? "" : "hidden"}" title="Drag link">‚ò∞</span>
        ${editMode ? linkEdit : linkView}
        <button class="btn-danger ${editMode ? "" : "hidden"}" onclick="deleteLink(${l.id})">‚úï</button>
      `;

      if (editMode) addLinkDnDHandlers(row);
      linksDiv.appendChild(row);
    });
  });
}

/* -------------------------
   Sections CRUD + Color
------------------------- */
async function createSection(){
  if (!editMode) return;
  const input = document.getElementById("sectionName");
  const name = input.value.trim();
  if (!name) return;

  const r = await fetch("/sections", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({name})
  });

  if (!r.ok){
    const txt = await r.text();
    alert(`Add section failed (${r.status}): ${txt}`);
    return;
  }
  input.value = "";
  load();
}

async function updateSectionName(id){
  if (!editMode) return;
  const el = document.getElementById(`rename-${id}`);
  const name = el.value.trim();
  if (!name) return alert("Name cannot be empty");

  const r = await fetch(`/sections/${id}`, {
    method:"PUT",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({name})
  });

  if (!r.ok){
    const txt = await r.text();
    alert(`Rename failed (${r.status}): ${txt}`);
    return;
  }
  load();
}

async function updateSectionColor(id){
  if (!editMode) return;
  const el = document.getElementById(`color-${id}`);
  const color = el.value;

  const r = await fetch(`/sections/${id}`, {
    method:"PUT",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({color})
  });

  if (!r.ok){
    const txt = await r.text();
    alert(`Set color failed (${r.status}): ${txt}`);
    return;
  }
  load();
}

async function deleteSection(id){
  if (!editMode) return;
  if(!confirm("Delete section and all its links?")) return;

  const r = await fetch(`/sections/${id}`, {method:"DELETE"});
  if (!r.ok){
    const txt = await r.text();
    alert(`Delete failed (${r.status}): ${txt}`);
    return;
  }
  load();
}

/* -------------------------
   Links CRUD
------------------------- */
async function addLink(sid){
  if (!editMode) return;

  const tEl = document.getElementById(`title-${sid}`);
  const uEl = document.getElementById(`url-${sid}`);
  const title = tEl.value.trim();
  const url = uEl.value.trim();
  if(!title || !url) return;

  const r = await fetch(`/sections/${sid}/links`, {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({title, url})
  });

  if (!r.ok){
    const txt = await r.text();
    alert(`Add link failed (${r.status}): ${txt}`);
    return;
  }

  tEl.value=""; uEl.value="";
  load();
}

async function updateLink(linkId){
  if (!editMode) return;

  const tEl = document.getElementById(`lt-${linkId}`);
  const uEl = document.getElementById(`lu-${linkId}`);
  const title = tEl.value.trim();
  const url = uEl.value.trim();
  if(!title || !url) return;

  const r = await fetch(`/links/${linkId}`, {
    method:"PUT",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({title, url})
  });

  if (!r.ok){
    const txt = await r.text();
    alert(`Update failed (${r.status}): ${txt}`);
    return;
  }
  load();
}

async function deleteLink(id){
  if (!editMode) return;
  if(!confirm("Delete this link?")) return;

  const r = await fetch(`/links/${id}`, {method:"DELETE"});
  if (!r.ok){
    const txt = await r.text();
    alert(`Delete failed (${r.status}): ${txt}`);
    return;
  }
  load();
}

/* -------------------------
   DnD: Sections (ONLY via handle)
------------------------- */
function addSectionDnDHandlers(card){
  const grid = document.getElementById("grid");
  const handle = card.querySelector(".section-handle");
  if (!handle) return;

  handle.draggable = true;

  handle.addEventListener("dragstart", (e) => {
    draggedSectionCard = card;
    card.classList.add("dragging");
    // needed for some browsers
    e.dataTransfer.setData("text/plain", card.dataset.sectionId || "");
    e.dataTransfer.effectAllowed = "move";
  });

  handle.addEventListener("dragend", () => {
    if (!draggedSectionCard) return;
    card.classList.remove("dragging");
    draggedSectionCard = null;
    dirtySectionsOrder = true;
  });

  card.addEventListener("dragover", (e) => {
    e.preventDefault();
    if (!draggedSectionCard) return;

    const after = [...grid.querySelectorAll(".section-card:not(.dragging)")]
      .find(el => e.clientY < el.getBoundingClientRect().top + el.offsetHeight / 2);

    if (after) grid.insertBefore(draggedSectionCard, after);
    else grid.appendChild(draggedSectionCard);
  });
}

async function persistSectionOrder(){
  const ordered = [...document.querySelectorAll(".section-card")]
    .map(x => parseInt(x.dataset.sectionId || "", 10))
    .filter(n => Number.isFinite(n) && n > 0);

  if (ordered.length === 0) {
    console.warn("persistSectionOrder(): no valid section ids found");
    return;
  }

  const r = await fetch(`/sections/reorder`, {
    method:"PUT",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ ordered_ids: ordered })
  });

  if (!r.ok){
    const txt = await r.text();
    alert(`Section reorder failed (${r.status}): ${txt}`);
  }
}

/* -------------------------
   DnD: Links (ONLY via handle)
------------------------- */
function addLinkDnDHandlers(row){
  const handle = row.querySelector(".drag-handle");
  if (!handle) return;

  handle.draggable = true;

  handle.addEventListener("dragstart", (e) => {
    draggedLinkEl = row;
    row.classList.add("dragging");
    e.dataTransfer.setData("text/plain", row.dataset.linkId || "");
    e.dataTransfer.effectAllowed = "move";
  });

  handle.addEventListener("dragend", () => {
    row.classList.remove("dragging");

    // ‚úÖ ALWAYS derive sectionId from DOM (never from row.dataset)
    const secCard = row.closest(".section-card");
    const sid = parseInt(secCard?.dataset.sectionId || "", 10);

    if (Number.isFinite(sid) && sid > 0) {
      dirtyLinksOrderBySection.add(sid);
    } else {
      console.warn("Could not resolve section id for link reorder", row);
    }

    draggedLinkEl = null;
  });

  row.addEventListener("dragover", (e) => {
    e.preventDefault();
    if (!draggedLinkEl) return;

    const container = row.parentElement;

    const after = [...container.querySelectorAll(".link-row:not(.dragging)")]
      .find(child => e.clientY < child.getBoundingClientRect().top + child.offsetHeight / 2);

    if (after) container.insertBefore(draggedLinkEl, after);
    else container.appendChild(draggedLinkEl);
  });
}

async function persistLinkOrder(sectionId){
  const sid = parseInt(String(sectionId), 10);
  if (!Number.isFinite(sid) || sid <= 0) return;

  const container = document.getElementById(`links-${sid}`);
  if (!container) return;

  const ordered = [...container.querySelectorAll(".link-row")]
    .map(x => parseInt(x.dataset.linkId || "", 10))
    .filter(n => Number.isFinite(n) && n > 0);

  const r = await fetch(`/sections/${sid}/links/reorder`, {
    method:"PUT",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ ordered_ids: ordered })
  });

  if (!r.ok){
    const txt = await r.text();
    alert(`Link reorder failed (${r.status}): ${txt}`);
  }
}

/* -------------------------
   Escapes
------------------------- */
function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function escapeAttr(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll('"',"&quot;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;");
}

load();
</script>
</body>
</html>
