<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>Links CRUD</title>
<style>
body{font-family:Arial;margin:20px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
.card{border:1px solid #ddd;border-radius:10px;padding:12px}
.row{display:flex;gap:8px;margin-top:8px}
input{flex:1;padding:8px}
button{cursor:pointer}

.link-row{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:6px 8px;border:1px solid #eee;border-radius:8px;margin:6px 0;background:white}
.link-row.dragging{opacity:.5}
.drag-handle{cursor:grab;user-select:none;font-size:14px;opacity:.7}
.link-title{flex:1;text-decoration:none}
.del-btn{padding:2px 6px;font-size:12px;border:none;border-radius:6px;cursor:pointer}
</style>
</head>
<body>
<h2>My Links</h2>
<div class="row">
  <input id="sectionName" placeholder="New section name"/>
  <button onclick="createSection()">Add Section</button>
</div>
<hr/>
<div id="grid" class="grid"></div>

<script>
const API="http://127.0.0.1:8000";
let draggedEl=null;

async function load(){
  const res=await fetch(`${API}/sections`);
  const sections=await res.json();
  const grid=document.getElementById("grid");
  grid.innerHTML="";
  sections.forEach(s=>{
    const div=document.createElement("div");
    div.className="card";
    div.innerHTML=`
      <h3>${s.name} <button onclick="deleteSection(${s.id})">üóëÔ∏è</button></h3>
      <div class="row">
        <input id="title-${s.id}" placeholder="Title"/>
        <input id="url-${s.id}" placeholder="https://..."/>
        <button onclick="addLink(${s.id})">Add</button>
      </div>
      <div id="links-${s.id}"></div>
    `;
    grid.appendChild(div);
    const linksDiv=div.querySelector(`#links-${s.id}`);
    s.links.forEach(l=>{
      const row=document.createElement("div");
      row.className="link-row";
      row.draggable=true;
      row.dataset.linkId=l.id;
      row.dataset.sectionId=s.id;
      row.innerHTML=`<span class="drag-handle">‚ò∞</span><a href="${l.url}" target="_blank" class="link-title">${l.title}</a><button class="del-btn" onclick="deleteLink(${l.id})">‚úï</button>`;
      addDnDHandlers(row);
      linksDiv.appendChild(row);
    });
  });
}

function addDnDHandlers(el){
  el.addEventListener("dragstart",e=>{draggedEl=el;el.classList.add("dragging")});
  el.addEventListener("dragend",async()=>{el.classList.remove("dragging");await persistLinkOrder(el.dataset.sectionId);draggedEl=null});
  el.addEventListener("dragover",e=>{
    e.preventDefault();
    const container=el.parentElement;
    const after=getDragAfter(container,e.clientY);
    if(after==null)container.appendChild(draggedEl);else container.insertBefore(draggedEl,after);
  });
}

function getDragAfter(container,y){
  const els=[...container.querySelectorAll(".link-row:not(.dragging)")];
  return els.reduce((closest,child)=>{
    const box=child.getBoundingClientRect();
    const offset=y-box.top-box.height/2;
    if(offset<0&&offset>closest.offset){return{offset,element:child}}else{return closest}
  },{offset:Number.NEGATIVE_INFINITY}).element;
}

async function persistLinkOrder(sectionId){
  const container=document.getElementById(`links-${sectionId}`);
  const ordered=[...container.querySelectorAll(".link-row")].map(x=>Number(x.dataset.linkId));
  await fetch(`${API}/sections/${sectionId}/links/reorder`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({ordered_ids:ordered})});
}

async function createSection(){const name=document.getElementById("sectionName").value.trim();if(!name)return;await fetch(`${API}/sections`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name})});document.getElementById("sectionName").value="";load();}
async function deleteSection(id){await fetch(`${API}/sections/${id}`,{method:"DELETE"});load();}
async function addLink(id){const t=document.getElementById(`title-${id}`).value.trim();const u=document.getElementById(`url-${id}`).value.trim();if(!t||!u)return;await fetch(`${API}/sections/${id}/links`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:t,url:u})});load();}
async function deleteLink(id){await fetch(`${API}/links/${id}`,{method:"DELETE"});load();}

load();
</script>
</body>
</html>
