<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>My Links</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background:#f7f7f7; }
  .topbar { display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; }
  .topbar h2 { margin:0; }
  .right { display:flex; gap:8px; align-items:center; }
  .hint { font-size:12px; opacity:.7; }

  .grid.view-layout{ display:grid; grid-template-columns:repeat(3, 1fr); gap:12px; }
  @media (max-width: 1100px){ .grid.view-layout{ grid-template-columns:repeat(2, 1fr); } }
  @media (max-width: 700px){ .grid.view-layout{ grid-template-columns:repeat(1, 1fr); } }

  .grid.edit-layout{ display:flex; flex-direction:column; gap:12px; align-items:center; }

  .card { border:1px solid #ddd; border-radius:12px; padding:12px; background:white; }
  .grid.edit-layout .section-card{ width:100%; max-width:1100px; }
  .section-card.dragging { opacity:.45; }

  .section-header { display:flex; justify-content:space-between; align-items:center; gap:10px; }
  .section-left { display:flex; align-items:center; gap:10px; flex:1; min-width:0; }

  .section-handle, .drag-handle {
    cursor:grab; user-select:none; opacity:.75; font-size:14px;
    padding:4px 6px; border-radius:8px; border:1px solid #eee; background:#fafafa;
  }
  .section-handle:active, .drag-handle:active { cursor:grabbing; }

  .row { display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
  input, select {
    flex:1; min-width:220px; padding:8px;
    border-radius:8px; border:1px solid #ddd;
  }

  button { cursor:pointer; padding:8px 10px; border-radius:8px; border:1px solid #ddd; background:#fafafa; }
  button:disabled { opacity:.5; cursor:not-allowed; }
  .btn-primary { background:#111; color:white; border-color:#111; }
  .btn-danger { background:#ff4d4d; color:white; font-size:12px; padding:4px 8px; border-radius:8px; border-color:#ff4d4d; }
  .btn-small { padding:6px 10px; font-size:12px; }

  .link-row {
    display:flex; align-items:center; gap:10px;
    padding:6px 8px;
    border:1px solid #eee;
    border-radius:10px;
    margin:6px 0;
    background:white;
  }
  .link-row.dragging { opacity:.5; }

  .link-title { flex:1; text-decoration:none; color:#111; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .link-title:hover { text-decoration:underline; }

  .hidden { display:none !important; }

  .section-color-bar { height:6px; border-radius:10px; margin:-12px -12px 10px -12px; }
  .c-slate { background:#64748b; }
  .c-blue { background:#3b82f6; }
  .c-green { background:#22c55e; }
  .c-amber { background:#f59e0b; }
  .c-red { background:#ef4444; }
  .c-purple { background:#a855f7; }
  .c-pink { background:#ec4899; }
  .c-teal { background:#14b8a6; }

  .edit-inline { display:flex; gap:8px; align-items:center; flex-wrap:wrap; width:100%; }
  .edit-inline input { min-width:200px; }
</style>
</head>
<body>

<div class="topbar">
  <h2>My Links</h2>
  <div class="right">
    <span id="modeHint" class="hint">View mode</span>
    <button id="editBtn" class="btn-primary" onclick="toggleEdit()">Edit</button>
  </div>
</div>

<div class="row">
  <input id="sectionName" placeholder="New section name (e.g., Tools)">
  <button id="addSectionBtn" onclick="createSection()" disabled>Add Section</button>
</div>

<hr>
<div id="grid" class="grid view-layout"></div>

<script>
let editMode = false;

let draggedSectionCard = null;
let draggedLinkEl = null;

const COLORS = [
  { value:"slate", label:"Slate" },
  { value:"blue", label:"Blue" },
  { value:"green", label:"Green" },
  { value:"amber", label:"Amber" },
  { value:"red", label:"Red" },
  { value:"purple", label:"Purple" },
  { value:"pink", label:"Pink" },
  { value:"teal", label:"Teal" },
];

function toggleEdit(){
  editMode = !editMode;
  load();
}

function setTopbar(){
  const hint = document.getElementById("modeHint");
  const btn = document.getElementById("editBtn");
  const addBtn = document.getElementById("addSectionBtn");
  const grid = document.getElementById("grid");

  if (editMode){
    hint.textContent = "Edit mode";
    btn.textContent = "Save";
    addBtn.disabled = false;
    grid.className = "grid edit-layout";
  } else {
    hint.textContent = "View mode";
    btn.textContent = "Edit";
    addBtn.disabled = true;
    grid.className = "grid view-layout";
  }
}

function colorOptionsHtml(selected){
  const s = (selected || "slate").toLowerCase();
  return COLORS.map(c => `<option value="${c.value}" ${c.value===s?"selected":""}>${c.label}</option>`).join("");
}

function safeInt(x){
  const n = parseInt(String(x ?? "").trim(), 10);
  return Number.isFinite(n) && n > 0 ? n : null;
}

async function load(){
  setTopbar();

  const res = await fetch("/sections");
  const sections = await res.json();

  const grid = document.getElementById("grid");
  grid.innerHTML = "";

  sections.forEach(s => {
    const card = document.createElement("div");
    card.className = "card section-card";
    card.dataset.sectionId = String(s.id);
    card.draggable = false;

    const color = (s.color || "slate").toLowerCase();

    const titleBlock = editMode
      ? `
        <div class="edit-inline">
          <input id="rename-${s.id}" value="${escapeAttr(s.name)}">
          <button class="btn-small" onclick="updateSection(${s.id})">Update</button>

          <select id="color-${s.id}">
            ${colorOptionsHtml(color)}
          </select>
        </div>
      `
      : `<h3 style="margin:0">${escapeHtml(s.name)}</h3>`;

    card.innerHTML = `
      <div class="section-color-bar c-${color}"></div>

      <div class="section-header">
        <div class="section-left">
          <span class="section-handle ${editMode ? "" : "hidden"}" title="Drag section">‚ò∞</span>
          ${titleBlock}
        </div>
        <button class="btn-danger ${editMode ? "" : "hidden"}" onclick="deleteSection(${s.id})">üóëÔ∏è</button>
      </div>

      <div class="row ${editMode ? "" : "hidden"}">
        <input id="title-${s.id}" placeholder="Title">
        <input id="url-${s.id}" placeholder="https://...">
        <button onclick="addLink(${s.id})">Add</button>
      </div>

      <div id="links-${s.id}"></div>
    `;

    if (editMode) addSectionDnDHandlers(card);
    grid.appendChild(card);

    const linksDiv = card.querySelector(`#links-${s.id}`);

    s.links.forEach(l => {
      const row = document.createElement("div");
      row.className = "link-row";
      row.dataset.linkId = String(l.id);
      row.draggable = false;

      const linkView = `<a href="${l.url}" target="_blank" class="link-title">${escapeHtml(l.title)}</a>`;

      const linkEdit = `
        <input id="lt-${l.id}" value="${escapeAttr(l.title)}">
        <input id="lu-${l.id}" value="${escapeAttr(l.url)}">
        <button class="btn-small" onclick="updateLink(${l.id})">Update</button>
      `;

      row.innerHTML = `
        <span class="drag-handle ${editMode ? "" : "hidden"}" title="Drag link">‚ò∞</span>
        ${editMode ? linkEdit : linkView}
        <button class="btn-danger ${editMode ? "" : "hidden"}" onclick="deleteLink(${l.id})">‚úï</button>
      `;

      if (editMode) addLinkDnDHandlers(row);
      linksDiv.appendChild(row);
    });
  });
}

/* -------- Sections CRUD -------- */
async function createSection(){
  if (!editMode) return;
  const input = document.getElementById("sectionName");
  const name = input.value.trim();
  if (!name) return;

  const r = await fetch("/sections", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({name})
  });

  if (!r.ok) return alert(await r.text());
  input.value = "";
  load();
}

async function updateSection(id){
  if (!editMode) return;
  const name = document.getElementById(`rename-${id}`).value.trim();
  const color = document.getElementById(`color-${id}`).value;

  if (!name) return alert("Name cannot be empty");

  const r = await fetch(`/sections/${id}`, {
    method:"PUT",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({name, color})
  });

  if (!r.ok) return alert(await r.text());
  load();
}

async function deleteSection(id){
  if (!editMode) return;
  if(!confirm("Delete section and all its links?")) return;

  const r = await fetch(`/sections/${id}`, {method:"DELETE"});
  if (!r.ok) return alert(await r.text());
  load();
}

/* -------- Links CRUD -------- */
async function addLink(sid){
  if (!editMode) return;
  const title = document.getElementById(`title-${sid}`).value.trim();
  const url = document.getElementById(`url-${sid}`).value.trim();
  if(!title || !url) return;

  const r = await fetch(`/sections/${sid}/links`, {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({title, url})
  });

  if (!r.ok) return alert(await r.text());

  document.getElementById(`title-${sid}`).value="";
  document.getElementById(`url-${sid}`).value="";
  load();
}

async function updateLink(linkId){
  if (!editMode) return;
  const title = document.getElementById(`lt-${linkId}`).value.trim();
  const url = document.getElementById(`lu-${linkId}`).value.trim();
  if(!title || !url) return;

  const r = await fetch(`/links/${linkId}`, {
    method:"PUT",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({title, url})
  });

  if (!r.ok) return alert(await r.text());
  load();
}

async function deleteLink(id){
  if (!editMode) return;
  if(!confirm("Delete this link?")) return;

  const r = await fetch(`/links/${id}`, {method:"DELETE"});
  if (!r.ok) return alert(await r.text());
  load();
}

/* -------- Reorder helpers -------- */
function getSectionOrder(){
  return [...document.querySelectorAll(".section-card")]
    .map(el => safeInt(el.dataset.sectionId))
    .filter(n => n !== null);
}

function getLinkOrder(sectionId){
  const container = document.getElementById(`links-${sectionId}`);
  if (!container) return [];
  return [...container.querySelectorAll(".link-row")]
    .map(el => safeInt(el.dataset.linkId))
    .filter(n => n !== null);
}

async function saveSectionOrder(){
  const ordered = getSectionOrder();
  if (!ordered.length) return;

  const r = await fetch(`/sections/reorder`, {
    method:"PUT",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ ordered_ids: ordered })
  });

  if (!r.ok) alert(`Section reorder failed: ${await r.text()}`);
}

async function saveLinkOrder(sectionId){
  const ordered = getLinkOrder(sectionId);
  if (!ordered.length) return;

  const r = await fetch(`/sections/${sectionId}/links/reorder`, {
    method:"PUT",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({ ordered_ids: ordered })
  });

  if (!r.ok) alert(`Link reorder failed: ${await r.text()}`);
}

/* -------- DnD Sections -------- */
function addSectionDnDHandlers(card){
  const grid = document.getElementById("grid");
  const handle = card.querySelector(".section-handle");
  if (!handle) return;

  handle.draggable = true;

  handle.addEventListener("dragstart", (e) => {
    draggedSectionCard = card;
    card.classList.add("dragging");
    e.dataTransfer.setData("text/plain", card.dataset.sectionId || "");
    e.dataTransfer.effectAllowed = "move";
  });

  handle.addEventListener("dragend", async () => {
    card.classList.remove("dragging");
    draggedSectionCard = null;
    await saveSectionOrder();
  });

  card.addEventListener("dragover", (e) => {
    e.preventDefault();
    if (!draggedSectionCard) return;

    const after = [...grid.querySelectorAll(".section-card:not(.dragging)")]
      .find(el => e.clientY < el.getBoundingClientRect().top + el.offsetHeight / 2);

    if (after) grid.insertBefore(draggedSectionCard, after);
    else grid.appendChild(draggedSectionCard);
  });
}

/* -------- DnD Links -------- */
function addLinkDnDHandlers(row){
  const handle = row.querySelector(".drag-handle");
  if (!handle) return;

  handle.draggable = true;

  handle.addEventListener("dragstart", (e) => {
    draggedLinkEl = row;
    row.classList.add("dragging");
    e.dataTransfer.setData("text/plain", row.dataset.linkId || "");
    e.dataTransfer.effectAllowed = "move";
  });

  handle.addEventListener("dragend", async () => {
    row.classList.remove("dragging");
    const secCard = row.closest(".section-card");
    const sid = safeInt(secCard?.dataset.sectionId);
    draggedLinkEl = null;
    if (!sid) return;
    await saveLinkOrder(sid);
  });

  row.addEventListener("dragover", (e) => {
    e.preventDefault();
    if (!draggedLinkEl) return;

    const container = row.parentElement;
    const after = [...container.querySelectorAll(".link-row:not(.dragging)")]
      .find(child => e.clientY < child.getBoundingClientRect().top + child.offsetHeight / 2);

    if (after) container.insertBefore(draggedLinkEl, after);
    else container.appendChild(draggedLinkEl);
  });
}

/* -------- Escapes -------- */
function escapeHtml(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}
function escapeAttr(str){
  return String(str)
    .replaceAll("&","&amp;")
    .replaceAll('"',"&quot;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;");
}

load();
</script>
</body>
</html>
