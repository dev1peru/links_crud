<!doctype html>
<html>
<head>
<meta charset="utf-8"/>
<title>Links CRUD</title>
<style>
  body { font-family: Arial; margin: 20px; background:#f7f7f7; }

  .topbar { display:flex; align-items:center; justify-content:space-between; margin-bottom:12px; }
  .topbar h2 { margin:0; }
  .right { display:flex; gap:8px; align-items:center; }

  /* VIEW MODE GRID */
  .grid.view-layout{
    display:grid;
    grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
    gap:12px;
  }

  /* EDIT MODE VERTICAL */
  .grid.edit-layout{
    display:flex;
    flex-direction:column;
    gap:12px;
    align-items:center;
  }

  .card {
    border:1px solid #ddd;
    border-radius:12px;
    padding:12px;
    background:white;
  }

  .grid.edit-layout .section-card{
    width:100%;
    max-width:1100px;
  }

  .section-card.dragging { opacity:.5; }

  .section-header { display:flex; justify-content:space-between; align-items:center; }
  .section-title { display:flex; gap:8px; align-items:center; }

  .section-handle, .drag-handle {
    cursor:grab;
    user-select:none;
    opacity:.7;
  }

  .row { display:flex; gap:8px; margin-top:10px; flex-wrap:wrap; }
  input { flex:1; min-width:240px; padding:8px; border-radius:8px; border:1px solid #ddd; }

  button { cursor:pointer; padding:8px 10px; border-radius:8px; border:1px solid #ddd; background:#fafafa; }
  button:disabled { opacity:.5; cursor:not-allowed; }

  .btn-primary { background:#111; color:white; }
  .btn-danger { background:#ff4d4d; color:white; font-size:12px; padding:4px 8px; border-radius:8px; }

  .link-row {
    display:flex; align-items:center; gap:10px;
    padding:6px 8px;
    border:1px solid #eee;
    border-radius:10px;
    margin:6px 0;
    background:white;
  }

  .link-row.dragging { opacity:.5; }
  .link-title { flex:1; text-decoration:none; color:#111; }
  .link-title:hover { text-decoration:underline; }

  .hidden { display:none !important; }
  .hint { font-size:12px; opacity:.7; }
</style>
</head>
<body>

<div class="topbar">
  <h2>My Links</h2>
  <div class="right">
    <span id="modeHint" class="hint">View mode</span>
    <button id="editBtn" class="btn-primary" onclick="toggleEdit()">Edit</button>
  </div>
</div>

<div class="row">
  <input id="sectionName" placeholder="New section name (e.g., Tools)">
  <button id="addSectionBtn" onclick="createSection()" disabled>Add Section</button>
</div>

<hr>
<div id="grid" class="grid view-layout"></div>

<script>
let editMode = false;
let dirtySectionsOrder = false;
const dirtyLinksOrderBySection = new Set();
let draggedLinkEl = null;
let draggedSectionCard = null;

function toggleEdit(){
  editMode = !editMode;
  if (!editMode) {
    saveAllOrders().then(() => load());
  } else {
    load();
  }
}

async function saveAllOrders(){
  if (dirtySectionsOrder) {
    await persistSectionOrder();
    dirtySectionsOrder = false;
  }
  for (const sid of dirtyLinksOrderBySection) {
    await persistLinkOrder(sid);
  }
  dirtyLinksOrderBySection.clear();
}

function setTopbar(){
  const hint = document.getElementById("modeHint");
  const btn = document.getElementById("editBtn");
  const addBtn = document.getElementById("addSectionBtn");
  const grid = document.getElementById("grid");

  if (editMode){
    hint.textContent = "Edit mode";
    btn.textContent = "Save";
    addBtn.disabled = false;
    grid.className = "grid edit-layout";
  } else {
    hint.textContent = "View mode";
    btn.textContent = "Edit";
    addBtn.disabled = true;
    grid.className = "grid view-layout";
  }
}

async function load(){
  setTopbar();
  const res = await fetch("/sections");
  const sections = await res.json();
  const grid = document.getElementById("grid");
  grid.innerHTML = "";

  sections.forEach(s => {
    const card = document.createElement("div");
    card.className = "card section-card";
    card.dataset.sectionId = s.id;
    card.draggable = editMode;

    card.innerHTML = `
      <div class="section-header">
        <div class="section-title">
          <span class="section-handle ${editMode?"":"hidden"}">‚ò∞</span>
          <h3 style="margin:0">${s.name}</h3>
        </div>
        <button class="btn-danger ${editMode?"":"hidden"}" onclick="deleteSection(${s.id})">üóëÔ∏è</button>
      </div>
      <div class="row ${editMode?"":"hidden"}">
        <input id="title-${s.id}" placeholder="Title">
        <input id="url-${s.id}" placeholder="https://...">
        <button onclick="addLink(${s.id})">Add</button>
      </div>
      <div id="links-${s.id}"></div>
    `;

    if (editMode) addSectionDnDHandlers(card);
    grid.appendChild(card);

    const linksDiv = card.querySelector(`#links-${s.id}`);
    s.links.forEach(l => {
      const row = document.createElement("div");
      row.className = "link-row";
      row.dataset.linkId = l.id;
      row.dataset.sectionId = s.id;
      row.draggable = editMode;

      row.innerHTML = `
        <span class="drag-handle ${editMode?"":"hidden"}">‚ò∞</span>
        <a href="${l.url}" target="_blank" class="link-title">${l.title}</a>
        <button class="btn-danger ${editMode?"":"hidden"}" onclick="deleteLink(${l.id})">‚úï</button>
      `;

      if (editMode) addLinkDnDHandlers(row);
      linksDiv.appendChild(row);
    });
  });
}

async function createSection(){
  const input = document.getElementById("sectionName");
  const name = input.value.trim();
  if (!name) return;

  await fetch("/sections", {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({name})});
  input.value = "";
  load();
}

async function deleteSection(id){ if(confirm("Delete section?")){ await fetch(`/sections/${id}`,{method:"DELETE"}); load(); } }

async function addLink(sid){
  const tEl = document.getElementById(`title-${sid}`);
  const uEl = document.getElementById(`url-${sid}`);
  const t = tEl.value.trim();
  const u = uEl.value.trim();
  if(!t||!u) return;
  await fetch(`/sections/${sid}/links`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({title:t,url:u})});
  tEl.value=""; uEl.value="";
  load();
}

async function deleteLink(id){ if(confirm("Delete link?")){ await fetch(`/links/${id}`,{method:"DELETE"}); load(); } }

function addSectionDnDHandlers(card){
  const grid = document.getElementById("grid");
  card.addEventListener("dragstart", ()=>{ draggedSectionCard=card; card.classList.add("dragging"); });
  card.addEventListener("dragend", ()=>{ card.classList.remove("dragging"); dirtySectionsOrder=true; });
  card.addEventListener("dragover", e=>{
    e.preventDefault();
    const after=[...grid.querySelectorAll(".section-card:not(.dragging)")].find(el=>e.clientY<el.getBoundingClientRect().top+el.offsetHeight/2);
    if(after) grid.insertBefore(draggedSectionCard,after); else grid.appendChild(draggedSectionCard);
  });
}

async function persistSectionOrder(){
  const ordered=[...document.querySelectorAll(".section-card")].map(x=>Number(x.dataset.sectionId));
  await fetch(`/sections/reorder`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({ordered_ids:ordered})});
}

function addLinkDnDHandlers(el){
  el.addEventListener("dragstart", ()=>{ draggedLinkEl=el; el.classList.add("dragging"); });
  el.addEventListener("dragend", ()=>{ el.classList.remove("dragging"); dirtyLinksOrderBySection.add(Number(el.dataset.sectionId)); });
  el.addEventListener("dragover", e=>{
    e.preventDefault();
    const container=el.parentElement;
    const after=[...container.querySelectorAll(".link-row:not(.dragging)")].find(child=>e.clientY<child.getBoundingClientRect().top+child.offsetHeight/2);
    if(after) container.insertBefore(draggedLinkEl,after); else container.appendChild(draggedLinkEl);
  });
}

async function persistLinkOrder(sectionId){
  const container=document.getElementById(`links-${sectionId}`);
  const ordered=[...container.querySelectorAll(".link-row")].map(x=>Number(x.dataset.linkId));
  await fetch(`/sections/${sectionId}/links/reorder`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({ordered_ids:ordered})});
}

load();
</script>
</body>
</html>
